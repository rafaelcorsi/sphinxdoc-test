

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="pt-br" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="pt-br" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Soft processor &mdash; Embarcados-Avançados Insper documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="index.html" class="icon icon-home"> Embarcados-Avançados
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Soft processor</a><ul>
<li><a class="reference internal" href="#plataform-designer">Plataform Designer</a><ul>
<li><a class="reference internal" href="#nios">NIOS</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#criando-um-simples-soc">Criando um simples SoC</a><ul>
<li><a class="reference internal" href="#conectando-clock-e-reset">Conectando Clock e Reset</a></li>
<li><a class="reference internal" href="#conectando-barramento">Conectando barramento</a><ul>
<li><a class="reference internal" href="#mapa-de-memoria">Mapa de memória</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configurando-nios">Configurando NIOS</a></li>
<li><a class="reference internal" href="#export">Export</a></li>
<li><a class="reference internal" href="#finalizando">Finalizando</a></li>
<li><a class="reference internal" href="#utilizando-o-componente">Utilizando o componente</a><ul>
<li><a class="reference internal" href="#finalizando-1">Finalizando</a></li>
</ul>
</li>
<li><a class="reference internal" href="#modificando-o-toplevel-vhd">Modificando o topLevel.vhd</a></li>
</ul>
</li>
<li><a class="reference internal" href="#programando-o-nios-soft-processor">Programando o NIOS - Soft processor</a><ul>
<li><a class="reference internal" href="#criando-o-projeto">Criando o projeto</a></li>
<li><a class="reference internal" href="#analisando-e-configurando-o-bsp">Analisando e configurando o bsp</a><ul>
<li><a class="reference internal" href="#jtag-uart-small-driver">Jtag-UART small driver</a></li>
<li><a class="reference internal" href="#gerando-o-bsp">Gerando o bsp</a></li>
</ul>
</li>
<li><a class="reference internal" href="#embarcando">Embarcando !</a><ul>
<li><a class="reference internal" href="#blink-led">Blink LED</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#entrega-2">Entrega 2</a></li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Embarcados-Avançados</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Soft processor</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/Tutorial-FPGA-NIOS.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p>Nesse tutorial iremos criar e customizar um soft processor (sistema
embarcado com um processador e periférico), embarcar na FPGA e escrever
um código para ele. Ao final, vamos ter os mesmos LEDs que do projeto
anterior, com operação simular, mas agora sendo controlados por um
programa e não por um hardware dedicado.</p>
<p>Para seguir esse tutorial, é necessário:</p>
<ul class="simple">
<li><p><strong>Hardware:</strong> DE10-Standard e acessórios</p></li>
<li><p><strong>Softwares:</strong> Quartus 18.01</p></li>
<li><p><strong>Documentos:</strong>
<a class="reference external" href="https://github.com/Insper/DE10-Standard-v.1.3.0-SystemCD/tree/master/Manual">DE10-Standard_User_manual.pdf</a></p></li>
</ul>
<p>Entrega no git:</p>
<ul class="simple">
<li><p><strong>Pasta:</strong> <code class="docutils literal notranslate"><span class="pre">Tutorial-FPGA-NIOS</span></code></p></li>
</ul>
<div class="section" id="soft-processor">
<h1>Soft processor<a class="headerlink" href="#soft-processor" title="Permalink to this headline">¶</a></h1>
<p>Projetos em HDL não são muito flexíveis, cada alteração no projeto
implica na modificação do Hardware o que não é algo tão simples. Além da
dificuldade de implementar as modificações, temos o tempo de teste e
compilação do projeto que não é algo imediato.</p>
<p>Uma solução para tornar o projeto mais flexível é o de tornar os LEDs
controlados não por uma lógica dedicada mas sim por um hardware que
possa executar uma série de instruções: um microcontrolador.</p>
<p>Como a FPGA pode implementar circuitos lógicos digitais, é possível
sintetizarmos um microcontrolador na FPGA e fazermos esse uC controlar
os LEDS (Sim:exclamation: o uC é um código em HDL). Agora a alteração na
lógica de controle depende do programa que será executado no uC,
tornando o projeto muito mais flexível.</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">point_right</dt>
<dd class="field-odd"><p>O ARM também é um código em HDL:</p>
</dd>
</dl>
<p><a class="reference external" href="https://www.arm.com/about/newsroom/arm-offers-free-access-to-cortex-m0-processor-ip-to-streamline-embedded-soc-design.php">https://www.arm.com/about/newsroom/arm-offers-free-access-to-cortex-m0-processor-ip-to-streamline-embedded-soc-design.php</a></p>
</div></blockquote>
<p>Processadores que são sintetizáveis em dispositivos lógicos programáveis
(FPGA,..) são chamados de <a class="reference external" href="https://en.wikipedia.org/wiki/Soft_microprocessor">Soft
Processor</a>.
Diversos são os Soft Processors disponíveis comercialmente/ open source:</p>
<ul>
<li><p><a class="reference external" href="https://www.intel.com/content/www/us/en/programmable/products/processors/support.html">NIOS II:
Intel</a></p></li>
<li><p><a class="reference external" href="https://www.xilinx.com/products/design-tools/microblaze.html">MicroBlazer:
Xilinx</a></p></li>
<li><dl class="field-list simple">
<dt class="field-odd">point_right</dt>
<dd class="field-odd"><p><a href="#id1"><span class="problematic" id="id2">`</span></a>LEON:</p>
</dd>
</dl>
<p>Gaisler &lt;<a class="reference external" href="https://www.gaisler.com/index.php/products/ipcores/soclibrary">https://www.gaisler.com/index.php/products/ipcores/soclibrary</a>&gt;`__
(aerospacial/ SPARCV8)</p>
</li>
<li><p>…</p></li>
</ul>
<p>A adição de periféricos e funcionalidades extras ao Soft Processor
(podemos por exemplo colocar um gerenciador de memória, timers,
controlador de rede, …) faz com que o sistema passe a ser chamado de
<a class="reference external" href="https://en.wikipedia.org/wiki/System_on_a_chip">System On Chip</a>
(SoC).</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">point_right</dt>
<dd class="field-odd"><p>Hard Processor são os microprocessadores tradicionais,</p>
</dd>
</dl>
<p>que não sofrem alteração de HW.</p>
</div></blockquote>
<p>Existem SoCs que não são implementados em FPGAs, mas ainda assim
concentram uma série de outros componentes em um único chip, é o caso
dos SoCs utilizados em celulares. Esses dispositivos, muitas vezes
utilizam SoCs que possuem além da parte de processamento, sistemas
responsáveis pela comunicação pela: interface gráfica; gestão des
câmeras; comunicação 4g; …. A Qualcomm é uma das empresas lideres do
setor com o dispositivo
<a class="reference external" href="https://www.qualcomm.com/snapdragon/processors/comparison">SnapDragon</a>.</p>
<div class="section" id="plataform-designer">
<h2>Plataform Designer<a class="headerlink" href="#plataform-designer" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">point_right</dt>
<dd class="field-odd"><p>O Platform Designer era chamado de QSYS, ainda da para</p>
</dd>
</dl>
<p>achar muitas coisas com essa referência</p>
</div></blockquote>
<p>O Platform Designer é um software disponível pela INtel e integrado no
Quartus que possibilita desenvolvermos sistemas complexos de forma
simples e visual. Com ele podemos adicionar e conectar <strong>Intellectual
property cores</strong> (IP Core) para desenvolvermos uma aplicação de maneira
rápida e visual.</p>
<p>Os IP cores podem ser da própria
<a class="reference external" href="https://www.intel.com/content/www/us/en/products/programmable/intellectual-property.html">Intel</a>,
de terceiros ou proprietários.</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">point_right</dt>
<dd class="field-odd"><p>Quer se aprofundar? Tem um curso online <a href="#id3"><span class="problematic" id="id4">`</span></a>Introduction</p>
</dd>
</dl>
<p>to Platform
Designer &lt;<a class="reference external" href="https://www.intel.com/content/www/us/en/programmable/support/training/course/iqsys101.html">https://www.intel.com/content/www/us/en/programmable/support/training/course/iqsys101.html</a>&gt;`__</p>
</div></blockquote>
<div class="section" id="nios">
<h3>NIOS<a class="headerlink" href="#nios" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Nios_II">NIOS</a> é o soft processor
fornecido pela Altera-Intel e integrado na ferramenta. O NIOS é baseado
na arquitetura do MIPS com <a class="reference external" href="https://www.intel.com/content/www/us/en/programmable/documentation/iga1420498949526.html#iga1409259423560">arquitetura de 32
bits</a>
e controle de exceções, barramento de comunicação, controle de memória,
… .</p>
<p>A figura a seguir descreve os componentes essenciais do NIOS (azul) e o
que é customizável (cinza).</p>
<div class="figure align-default" id="id6">
<img alt="Nios block diagram" src="_images/Tutorial-FPGA-NIOS:core.png" />
<p class="caption"><span class="caption-text">Nios block diagram</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</div>
<ul class="simple">
<li><p><a class="reference external" href="https://www.intel.com/content/www/us/en/programmable/documentation/iga1420498949526.html#iga1409259423560">Processor
Architecture</a></p></li>
</ul>
<p>O NIOS suporta que novas instruções sejam adicionadas a seu instruction
set, essas instruções são implementadas em HDL e inseridas no core de
forma transparente ao desenvolvedor. Existem graus de instruções
customizadas: Combinacional; Multiciclo; Estendidas; Que faz uso do
banco de registradores original ou aquelas que adicionam novos
registradores. Para maiores detalhes consulte o documento :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.intel.com/content/dam/altera-www/global/en_US/pdfs/literature/ug/ug_nios2_custom_instruction.pdf">Nios II Custom Instruction User
Guide</a></p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="criando-um-simples-soc">
<h1>Criando um simples SoC<a class="headerlink" href="#criando-um-simples-soc" title="Permalink to this headline">¶</a></h1>
<p>Nesse etapa iremos adicionar um processador e a infraestrutura mínima
necessária para sua operação, iremos incluir no projeto:</p>
<ul class="simple">
<li><p>Uma interface de clock</p></li>
<li><p>Uma memória (de dados e programa)</p></li>
<li><p>O processador (NIOS II)</p></li>
<li><p>Um periférico PIO (para gerenciar saídas digitais)</p></li>
<li><p>Um JTAG-UART, para suportar debug via print.</p></li>
</ul>
<p>Para começarmos:</p>
<ol class="arabic simple">
<li><p>Copie a pasta do projeto da <code class="docutils literal notranslate"><span class="pre">Entrega-1</span></code> renomeando para
<code class="docutils literal notranslate"><span class="pre">Tutorial-FPGA-NIOS</span></code></p></li>
<li><p>Abra essa nova pasta <code class="docutils literal notranslate"><span class="pre">Tutorial-FPGA-NIOS</span></code> no Quartus</p></li>
<li><p>Abra o Platform Designer:</p></li>
</ol>
<ul class="simple">
<li><p><strong>Quartus</strong> :arrow_right: <code class="docutils literal notranslate"><span class="pre">Tools</span></code> :arrow_right:
<code class="docutils literal notranslate"><span class="pre">Platform</span> <span class="pre">Designer</span></code></p></li>
</ul>
<ol class="arabic simple" start="4">
<li><p>Adicione os seguintes periféricos:</p></li>
</ol>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">On-Chip</span> <span class="pre">Memmory</span> <span class="pre">(RAM</span> <span class="pre">or</span> <span class="pre">ROM</span> <span class="pre">Intel</span> <span class="pre">FPGA</span> <span class="pre">IP)</span></code></p>
<ul>
<li><p>Type: <strong>RAM</strong></p></li>
<li><p>Total Memory size: <strong>32768 bytes</strong></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">JTAG</span> <span class="pre">UART</span> <span class="pre">Intel</span> <span class="pre">FPGA</span> <span class="pre">IP</span></code></p>
<ul>
<li><p><strong>Default</strong></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">PIO</span> <span class="pre">(Parallel</span> <span class="pre">I/O)</span> <span class="pre">Intel</span> <span class="pre">FPGA</span> <span class="pre">IP</span></code></p>
<ul>
<li><p>Width: <strong>6</strong></p></li>
<li><p>Direction: <strong>Output</strong></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">NIOS</span> <span class="pre">II</span></code></p>
<ul>
<li><p>Type: <strong>NIOS II/e</strong></p></li>
</ul>
</li>
</ul>
<p>Você deve obter algo similar a:</p>
<div class="figure align-default" id="id7">
<img alt="Clock e Reset" src="_images/Tutorial-FPGA-NIOS:unconnected.png" />
<p class="caption"><span class="caption-text">Clock e Reset</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="conectando-clock-e-reset">
<h2>Conectando Clock e Reset<a class="headerlink" href="#conectando-clock-e-reset" title="Permalink to this headline">¶</a></h2>
<p>Os periféricos do Qsys são como sistemas independentes (pensem em cada
bloco é como um chip), que necessitam ser conectados no mínimo a um
Clock e a um Reset. O sistema pode operar em diversos domínios de clocks
e resets diferentes, portanto essa conexão deve ser feita pelo
desenvolvedor.</p>
<p>Pense nessa etapa como sendo similar ao port map do VHDL, porém em um
nível muito mais superior. O Qsys será responsável por fazer a
compatibilidade dos sinais para nós. Conecte todos os sinais de clocks e
reset aos sinais <code class="docutils literal notranslate"><span class="pre">clk</span></code> e <code class="docutils literal notranslate"><span class="pre">clk_rst</span></code> do periférico <code class="docutils literal notranslate"><span class="pre">clk_0</span></code>, conforme
figura a seguir:</p>
<div class="figure align-default" id="id8">
<img alt="Clock e Reset" src="_images/Tutorial-FPGA-NIOS:rst.png" />
<p class="caption"><span class="caption-text">Clock e Reset</span><a class="headerlink" href="#id8" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="conectando-barramento">
<h2>Conectando barramento<a class="headerlink" href="#conectando-barramento" title="Permalink to this headline">¶</a></h2>
<p>A Altera define dois tipos de barramento de dados para o Qsys: Avalon e
AXI. O barramento Avalon é a principal maneira de conectar um periférico
ao NIOS (processador), já o AXI é o padrão de barramento do ARM, que
será utilizado posteriormente.</p>
<p>O barramento Avalon define basicamente dois tipos de comunicação:
<strong>Memory Mapped (MM)</strong> e <strong>Avalon Streaming Interface (ST)</strong>, conforme
descrição a seguir extraído da documentação :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.altera.com/content/dam/altera-www/global/en_US/pdfs/literature/manual/mnl_avalon_spec.pdf">Avalon Interface
Specifications</a></p></li>
</ul>
<p>O principal barramento do NIOS é o <a class="reference external" href="https://en.wikipedia.org/wiki/Memory-mapped_I/O">memory
mapped</a>, e todo
periférico conectado ao <strong>NIOS</strong> (processador) deverá possuir esse
barramento. A Altera disponibiliza conversores e adaptadores para
podermos transforma uma forma de comunicação na outra.</p>
<blockquote>
<div><p>Em um futuro breve nós iremos desenvolver um periférico proprietário
que será conectado nesse barramento. Melhorando o entendimento do
sistema.</p>
</div></blockquote>
<p>Note que o NIOS possui dois barramentos do tipo <strong>MM</strong>: <code class="docutils literal notranslate"><span class="pre">data_master</span></code>
e <code class="docutils literal notranslate"><span class="pre">intruction_master</span></code>. Como o NIOS II é um processador baseado no MIPS
<a class="reference external" href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.faqs/ka3839.html">harvard</a>
ele possui dois barramentos, um para dados e outro para o programa
(instrução).</p>
<p>Nessa nossa topologia de hardware, só possuímos uma única memória
(<strong>on_chip_memory</strong>) que será a principio compartilhada entre o dado e
programa (temos uma perda de eficiência aqui, já que a memória só poderá
ser acessada por um barramento por vez), <strong>depois vamos melhorar isso!</strong></p>
<p>Vamos portanto conectar todos os periféricos (<strong>PIO</strong>, <strong>UART</strong> e
<strong>OnChip Memory</strong>) ao barramento <code class="docutils literal notranslate"><span class="pre">data_master</span></code> e vamos conectar
somente a memória (<strong>OnChip Memory</strong>) ao barramento de instrução
(<code class="docutils literal notranslate"><span class="pre">instruction_master</span></code>), resultando na montagem a seguir:</p>
<p><img alt="image0" src="_images/Tutorial-FPGA-NIOS:connected.png" /></p>
<div class="section" id="mapa-de-memoria">
<h3>Mapa de memória<a class="headerlink" href="#mapa-de-memoria" title="Permalink to this headline">¶</a></h3>
<p>Após realizarmos as conexões, devemos especificar o endereço de memória
de cada periférico. São duas as maneiras de realizarmos isso: manual ou
automática.</p>
<p>Na manual, pode-se alocar os periféricos em endereços de memória a sua
escolha, tomando os cuidados para não haver sobreposição dos endereços.
Na automática, deixamos para a ferramenta alocar os periféricos nos
endereços corretos.</p>
<p>Para realizar a alocação automática: <code class="docutils literal notranslate"><span class="pre">System</span></code> :arrow_right:
<code class="docutils literal notranslate"><span class="pre">Assign</span> <span class="pre">Base</span> <span class="pre">Addrress</span></code>. Para visualizar o resultado, clique na aba:
<code class="docutils literal notranslate"><span class="pre">Address</span> <span class="pre">Map</span></code></p>
<div class="figure align-default" id="id9">
<img alt="Automatic Memmory Map" src="_images/Tutorial-FPGA-NIOS:mem-mapped.png" />
<p class="caption"><span class="caption-text">Automatic Memmory Map</span><a class="headerlink" href="#id9" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="configurando-nios">
<h2>Configurando NIOS<a class="headerlink" href="#configurando-nios" title="Permalink to this headline">¶</a></h2>
<p>Agora precisamos configurar o NIOS para utilizar a memória recém
conectada a ele, de um clique duplo no NIOS, para abrir a aba:
<strong>Parameters</strong>.</p>
<p>Em <code class="docutils literal notranslate"><span class="pre">Vector</span></code> :arrow_right: <code class="docutils literal notranslate"><span class="pre">configure</span></code>:</p>
<ul class="simple">
<li><p>Reset vector memory: <strong>onchip_memory</strong></p></li>
<li><p>Execption vector memory: <strong>onchip_memory</strong></p></li>
</ul>
<p><img alt="image1" src="_images/Tutorial-FPGA-NIOS:vector.png" /></p>
<blockquote>
<div><p>O nome <strong>onchip_memory</strong> pode alterar de acordo com o seu projeto e o
endereço também (isso depende da ordem na qual os componentes foram
inseridos).</p>
</div></blockquote>
</div>
<div class="section" id="export">
<h2>Export<a class="headerlink" href="#export" title="Permalink to this headline">¶</a></h2>
<p>A coluna export do <strong>Platform Designer</strong> indica quais sinais serão
exportados para fora do sistema, pense nesses sinais como sendo os que
terão contato com o mundo externo (serão mapeados para os pinos no
topLevel).</p>
<p>De um clique duplo na coluna export na linha do sinal
<strong>external_connection</strong> do component <strong>PIO</strong> e de o nome de LEDs para
esse sinal.</p>
</div>
<div class="section" id="finalizando">
<h2>Finalizando<a class="headerlink" href="#finalizando" title="Permalink to this headline">¶</a></h2>
<p>Ao final de tudo você deve obter algo como a figura a seguir:</p>
<div class="figure align-default" id="id10">
<img alt="Qsys final" src="_images/Tutorial-FPGA-NIOS:MM.png" />
<p class="caption"><span class="caption-text">Qsys final</span><a class="headerlink" href="#id10" title="Permalink to this image">¶</a></p>
</div>
<p>Salve o projeto com o nome <code class="docutils literal notranslate"><span class="pre">niosHello.qsys</span></code> na pasta do projeto e
clique em <code class="docutils literal notranslate"><span class="pre">Generate</span> <span class="pre">HDL</span></code>, para o Qsys gerar o projeto.</p>
</div>
<div class="section" id="utilizando-o-componente">
<h2>Utilizando o componente<a class="headerlink" href="#utilizando-o-componente" title="Permalink to this headline">¶</a></h2>
<p>Ainda no Qsys, clique em: <code class="docutils literal notranslate"><span class="pre">Generate</span></code> :arrow_right:
<code class="docutils literal notranslate"><span class="pre">Show</span> <span class="pre">Instatiation</span> <span class="pre">Template</span></code>, selecione VHDL como linguagem HDL. E
você deve obter algo como:</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">point_right</dt>
<dd class="field-odd"><p>Anote isso, iremos utilizar na próxima etapa!</p>
</dd>
</dl>
</div></blockquote>
<div class="highlight-vhd notranslate"><div class="highlight"><pre><span></span>component niosHello is
    port (
        clk_clk       : in  std_logic                    := &#39;X&#39;; -- clk
        reset_reset_n : in  std_logic                    := &#39;X&#39;; -- reset_n
        leds_export   : out std_logic_vector(5 downto 0)         -- export
    );
end component niosHello;

u0 : component niosHello
    port map (
        clk_clk       =&gt; CONNECTED_TO_clk_clk,       --  clk.clk
        reset_reset_n =&gt; CONNECTED_TO_reset_reset_n, --  reset.reset_n
        leds_export   =&gt; CONNECTED_TO_leds_export    --  leds.export
    );
</pre></div>
</div>
<p>Isso é um atalho de como devemos utilizar esse componente no nosso
projeto. Esse trecho de código indica que o projeto recém criado no Qsys
possui três interfaces externas: <code class="docutils literal notranslate"><span class="pre">clk_clk</span></code>, <code class="docutils literal notranslate"><span class="pre">reset_reset_n</span></code> e
<code class="docutils literal notranslate"><span class="pre">leds_export</span></code>. Esse sinais terão que ser mapeados no topLevel para
seus respectivos pinos.</p>
<blockquote>
<div><p>esse nomes podem mudar no seu projeto!</p>
</div></blockquote>
<p>O esquemático (gerado pelo <code class="docutils literal notranslate"><span class="pre">Platform</span> <span class="pre">Designer</span></code> :arrow_right: <code class="docutils literal notranslate"><span class="pre">View</span></code>
:arrow_right: <code class="docutils literal notranslate"><span class="pre">Schematic</span></code>) ilustra o SoC recém criado e suas
interfaces:</p>
<div class="figure align-default" id="id11">
<img alt="Schematic" src="_images/Tutorial-FPGA-NIOS:schematic.png" />
<p class="caption"><span class="caption-text">Schematic</span><a class="headerlink" href="#id11" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="finalizando-1">
<span id="id5"></span><h3>Finalizando<a class="headerlink" href="#finalizando-1" title="Permalink to this headline">¶</a></h3>
<p>Clique em finish e deixe tudo como o padrão, agora o qsys irá criar o
sistema e todos os componentes que nele foi configurado. O Quartus dará
uma alerta indicando que é necessário incluir alguns arquivos no Quartus
para que ele tenha acesso ao projeto recém criado no Qsys:</p>
<div class="figure align-default" id="id12">
<img alt="Add arquivos" src="_images/Tutorial-FPGA-NIOS:addQuartus.png" />
<p class="caption"><span class="caption-text">Add arquivos</span><a class="headerlink" href="#id12" title="Permalink to this image">¶</a></p>
</div>
<p>No Quartus: <code class="docutils literal notranslate"><span class="pre">Project</span></code> :arrow_right: <code class="docutils literal notranslate"><span class="pre">Add/remove</span> <span class="pre">files</span> <span class="pre">in</span> <span class="pre">project</span></code> e
adicione o arquivo:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">niosHello/synthesis/niosHello.qip</span></code></p></li>
</ul>
<p>Resultando em:</p>
<div class="figure align-default" id="id13">
<img alt="Files" src="_images/Tutorial-FPGA-NIOS:file.png" />
<p class="caption"><span class="caption-text">Files</span><a class="headerlink" href="#id13" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="modificando-o-toplevel-vhd">
<h2>Modificando o topLevel.vhd<a class="headerlink" href="#modificando-o-toplevel-vhd" title="Permalink to this headline">¶</a></h2>
<p>Agora é necessário modificar o <code class="docutils literal notranslate"><span class="pre">topLevel.vhd</span></code> para incluir o
componente <code class="docutils literal notranslate"><span class="pre">niosHello</span></code> recém criado. Note que não estamos utilizando o
sinal de reset (o <code class="docutils literal notranslate"><span class="pre">_n</span></code> indica que o reset é negativo, ou seja, em
<code class="docutils literal notranslate"><span class="pre">0</span></code>).</p>
<div class="highlight-vhd notranslate"><div class="highlight"><pre><span></span>library IEEE;
use IEEE.std_logic_1164.all;

entity topLevel is
    port (
        -- Gloabals
        fpga_clk_50        : in  std_logic;             -- clock.clk

        -- I/Os
        fpga_led_pio       : out std_logic_vector(5 downto 0)
    );
end entity topLevel;

architecture rtl of topLevel is

component niosHello is port (
  clk_clk       : in  std_logic                    := &#39;X&#39;; -- clk
  reset_reset_n : in  std_logic                    := &#39;X&#39;; -- reset_n
  leds_export   : out std_logic_vector(5 downto 0)         -- export
);
end component niosHello;

begin

u0 : component niosHello port map (
  clk_clk       =&gt; fpga_clk_50,    --  clk.clk
  reset_reset_n =&gt; &#39;1&#39;,            --  reset.reset_n
  leds_export   =&gt; fpga_led_pio    --  leds.export
);

end rtl;
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Compile o projeto e analise o RTL, verifique se está de acordo com o
esperado.</p></li>
<li><p>Grave o projeto na FPGA.</p></li>
</ol>
</div>
</div>
<div class="section" id="programando-o-nios-soft-processor">
<h1>Programando o NIOS - Soft processor<a class="headerlink" href="#programando-o-nios-soft-processor" title="Permalink to this headline">¶</a></h1>
<p>Agora que temos o projeto criado e a FPGA gravada com o novo hardware,
que inclui o processador NIOS. Precisamos gerar e gravar um programa que
realiza o controle dos LEDs. Para isso iremos abrir a IDE <strong>NIOS
Software Build for Eclipse</strong> (SBT) que possui todo o toolchain
necessário para desenvolvermos firmware para o NIOS.</p>
<p>No Quartus: <code class="docutils literal notranslate"><span class="pre">Tools</span></code> :arrow_right: <code class="docutils literal notranslate"><span class="pre">Nios</span> <span class="pre">II</span> <span class="pre">Software</span> <span class="pre">Build</span> <span class="pre">...</span></code> e uma
interface do eclipse será aberta.</p>
<p>Quando desenvolvemos projetos para sistemas SoCs temos um problema: o
hardware não é padronizado. Como tudo é customizado existe um problema
que deve-se ser tratado, a interface entre o hardware criado e o
toolchain de software (compilador, linker…).</p>
<p>A Altera resolveu isso criando uma camada de abstração de hardware
(<strong>H</strong>ardware <strong>A</strong>bstraction <strong>L</strong>ayer - HAL) ou como a Intel
chama: <strong>B</strong>oard <strong>S</strong>uport <strong>P</strong>ackage (BSP), na qual extrai-se
informações do Platform Designer para ser utilizado pela toolchain de
compilação (GCC). Quando formos criar um projeto no <strong>NIOS II -
Eclipse</strong>, dois projetos serão criados: Um que contém o firmware a ser
gravado no NIOS e outro (BSP) que contém informações relevantes sobre o
Hardware para uso no firmware e toolchain.</p>
<div class="figure align-default" id="id14">
<img alt="SBT" src="https://www.altera.com/content/dam/altera-www/global/en_US/images/devices/processor/images/n2-soft-dev-tools.gif" />
<p class="caption"><span class="caption-text">SBT</span><a class="headerlink" href="#id14" title="Permalink to this image">¶</a></p>
</div>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">point_right</dt>
<dd class="field-odd"><p>Para mais informações:</p>
</dd>
</dl>
<p><a class="reference external" href="https://www.altera.com/products/processors/design-tools.html#SBT">https://www.altera.com/products/processors/design-tools.html#SBT</a></p>
</div></blockquote>
<div class="section" id="criando-o-projeto">
<h2>Criando o projeto<a class="headerlink" href="#criando-o-projeto" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>No <strong>Quartus</strong> :arrow_right: <code class="docutils literal notranslate"><span class="pre">Tools</span></code> :arrow_right:
<code class="docutils literal notranslate"><span class="pre">NIOS</span> <span class="pre">II</span> <span class="pre">-</span> <span class="pre">Eclipse</span></code></p></li>
<li><p>No <strong>NIOS II - Eclipse</strong> :arrow_right: <code class="docutils literal notranslate"><span class="pre">File</span></code> :arrow_right:
<code class="docutils literal notranslate"><span class="pre">NIOS</span> <span class="pre">II</span> <span class="pre">Application</span> <span class="pre">and</span> <span class="pre">BSP</span> <span class="pre">from</span> <span class="pre">template</span></code></p></li>
</ol>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SOPC</span> <span class="pre">Information</span> <span class="pre">File</span> <span class="pre">Name</span></code>:</p>
<ul>
<li><p>Na pasta do projeto, procure pelo arquivo : <code class="docutils literal notranslate"><span class="pre">niosHello.sopc</span></code></p>
<ul>
<li><p>Esse arquivo é criado pelo Qsys quando o projeto é compilado, e
está na pasta do projeto.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Project name: <code class="docutils literal notranslate"><span class="pre">niosHello</span></code></p></li>
<li><p>Após avançar o SBT irá criar duas pastas de projeto :</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">niosHello</span></code>: firmware a ser embarcado</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">niosHello_bsp</span></code>: Board support package para o firmware</p></li>
</ul>
</li>
</ul>
<p><img alt="image2" src="_images/Tutorial-FPGA-NIOS:project.png" /></p>
</div>
<div class="section" id="analisando-e-configurando-o-bsp">
<h2>Analisando e configurando o bsp<a class="headerlink" href="#analisando-e-configurando-o-bsp" title="Permalink to this headline">¶</a></h2>
<p>No Project Explorer do Eclipse, clique com o botão direito no:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Project</span> <span class="pre">Explorer</span></code> :arrow_right: <code class="docutils literal notranslate"><span class="pre">niosHello_bsp</span></code> :arrow_right:
<code class="docutils literal notranslate"><span class="pre">NIOS</span> <span class="pre">II</span></code> :arrow_right: <code class="docutils literal notranslate"><span class="pre">bsp</span> <span class="pre">Editor</span></code></p></li>
</ul>
<p>Isso abrirá uma interface de configuração para o bsp. Diversas são as
opções de configurações, algumas delas :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sys_clk_timer</span></code>: periférico utilizado para bibliotecas de delay
(não inserimos no Platform Designer)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">timestamp_timer</span></code>: periférico que seria utilizado pelo timestamp</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stdin</span></code>, <code class="docutils literal notranslate"><span class="pre">stdout</span></code>, <code class="docutils literal notranslate"><span class="pre">sterr</span></code>: periférico utilizado pelo
<strong>stantard IO</strong> do C, no nosso caso: <code class="docutils literal notranslate"><span class="pre">jtat_uart_0</span></code> (poderia ser
outro).</p></li>
</ul>
<p>Note que a região de memória do stack já está configurada para a
onchip_memory. Aqui teríamos a opção de mapear para outro local (no caso
do sistema possuir outras memórias, tais como memórias DDR externas a
FPGA).</p>
<p><img alt="image3" src="_images/Tutorial-FPGA-NIOS:bsp.png" /></p>
<div class="section" id="jtag-uart-small-driver">
<h3>Jtag-UART small driver<a class="headerlink" href="#jtag-uart-small-driver" title="Permalink to this headline">¶</a></h3>
<p>Note que no nosso projeto no QSYS o periférico jtag-uart não teve seu
sinal de interrupção conectado no NIOS, isso dificulta o acesso a uart,
já que o firmware não será interrompido caso um novo dado chegue (gets)
ou na transmissão (puts). O driver deve ficar fazendo um polling no
periférico para verificar o envio e recepção dos dados. Para isso
funcionar, devemos ativar uma opção no driver do jtag_avalon no bsp:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BSP</span> <span class="pre">Editor</span></code> :arrow_right: <code class="docutils literal notranslate"><span class="pre">Drivers</span></code> :arrow_right: <code class="docutils literal notranslate"><span class="pre">jtag_uart</span></code>
:arrow_right: <code class="docutils literal notranslate"><span class="pre">enable_small_driver</span></code></p></li>
</ul>
<div class="figure align-default" id="id15">
<img alt="Jtag Small Driver" src="_images/Tutorial-FPGA-NIOS:smallDriver.png" />
<p class="caption"><span class="caption-text">Jtag Small Driver</span><a class="headerlink" href="#id15" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="gerando-o-bsp">
<h3>Gerando o bsp<a class="headerlink" href="#gerando-o-bsp" title="Permalink to this headline">¶</a></h3>
<p>Toda vez que o bsp for editado ou o hardware alterado (qsys) deve-se
regenerar o bsp :</p>
<p>De volta no eclipse, devemos gerar os arquivos bsp. Para isso clique em:
<code class="docutils literal notranslate"><span class="pre">niosHello_bsp</span></code> :arrow_right: <code class="docutils literal notranslate"><span class="pre">NIOS</span> <span class="pre">II</span></code> :arrow_right:
<code class="docutils literal notranslate"><span class="pre">Generate</span> <span class="pre">BSP</span></code></p>
</div>
</div>
<div class="section" id="embarcando">
<h2>Embarcando !<a class="headerlink" href="#embarcando" title="Permalink to this headline">¶</a></h2>
<p>Com o bsp editado abra agora a pasta <code class="docutils literal notranslate"><span class="pre">niosHello</span></code> e note que existe
inicializada com um arquivo: <code class="docutils literal notranslate"><span class="pre">hello_world.c</span></code> que imprime via JTAG-UART
uma string. Insira o código a seguir no eclipse:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello from Nios II!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Com o <code class="docutils literal notranslate"><span class="pre">hello_word.c</span></code> aberto (é necessário para o eclipse saber qual
projeto você quer embarcar), clique em: <code class="docutils literal notranslate"><span class="pre">Run</span></code> :arrow_right: <code class="docutils literal notranslate"><span class="pre">Run</span></code>
:arrow_right: <code class="docutils literal notranslate"><span class="pre">NIOS</span> <span class="pre">II</span> <span class="pre">Hardware</span></code>. Isso fará com que a aplicação seja
descarregada na memória do Qsys que alocamos para o Nios e que o
hardware seja reiniciado para executar o firmware. Quando o firmware for
executado, abra a aba do eclipse <strong>NIOS II console</strong>:</p>
<div class="figure align-default" id="id16">
<img alt="printf" src="_images/Tutorial-FPGA-NIOS:console.png" />
<p class="caption"><span class="caption-text">printf</span><a class="headerlink" href="#id16" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="blink-led">
<h3>Blink LED<a class="headerlink" href="#blink-led" title="Permalink to this headline">¶</a></h3>
<p>Edite main para conter o código a seguir:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;system.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;alt_types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;io.h&gt; /* Leiutura e escrita no Avalon */</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">delay</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">){</span>
      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
      <span class="k">while</span><span class="p">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">){</span>
          <span class="n">delay</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Embarcados++ </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">led</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">){</span>
          <span class="n">IOWR_32DIRECT</span><span class="p">(</span><span class="n">PIO_0_BASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">led</span><span class="o">++</span><span class="p">);</span>
          <span class="n">usleep</span><span class="p">(</span><span class="mi">50000</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>
          <span class="n">led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<blockquote>
<div><p>Embarque no NIOS e veja o resultado nos LEDS!</p>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="entrega-2">
<h1>Entrega 2<a class="headerlink" href="#entrega-2" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">point_right</dt>
<dd class="field-odd"><p>Siga para a <a class="reference external" href="Entrega-2">Entrega 2</a></p>
</dd>
</dl>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, R. Corsi

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>